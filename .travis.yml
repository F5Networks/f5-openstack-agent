sudo: required
env:
  global:
    - DIST_REPO="f5-openstack-agent-dist"
    - PKG_VERSION=`python -c "import f5_openstack_agent; print(f5_openstack_agent.__version__)"`
    - PKG_RELEASE=$(python ${DIST_REPO}/scripts/get-version-release.py --release)
    - PKG_RELEASE_EL7=${DIST_REPO}/rpms/build/f5-openstack-agent-${PKG_VERSION}-${PKG_RELEASE}.el7.noarch.rpm
    - PKG_RELEASE_1404=${DIST_REPO}/deb_dist/python-f5-openstack-agent_${PKG_VERSION}-${PKG_RELEASE}_1404_all.deb
    - RELEASE_TAG=v$(echo $PKG_VERSION | cut -d . -f 1,2)

services:
- docker
language: python

python:
    - '2.7'
before_install:
    - git config --global user.email "OpenStack_TravisCI@f5.com"
    - git config --global user.name "Travis F5 Openstack"
    - wget https://github.com/F5Networks/docker-images/raw/master/centos:6.tar.gz
    - wget https://github.com/F5Networks/docker-images/raw/master/centos:7.tar.gz
    - wget https://github.com/F5Networks/docker-images/raw/master/f5devcentral_containthedocs:latest.tar.gz
    - wget https://github.com/F5Networks/docker-images/raw/master/ubuntu:trusty.tar.gz
    - docker load -i centos:6.tar.gz
    - docker load -i centos:7.tar.gz
    - docker load -i f5devcentral_containthedocs:latest.tar.gz
    - docker load -i ubuntu:trusty.tar.gz
install:
    - python -m pip install pip==19.0.3
    - pip install -Iv tox==3.25.1
    - pip install -r requirements.style.txt
script:
    - pep257 ./test/functional/neutronless/esd/test_esd.py
    - flake8 --ignore=H304 ./test/functional/neutronless/esd/test_esd.py
    - pep257 ./test/functional/neutronless/esd/conftest.py
    - flake8 --ignore=H304 ./test/functional/neutronless/esd/conftest.py
    - pep257 ./test/functional/neutronless/esd/test_esd_pairs.py
    - flake8 --ignore=H304 ./test/functional/neutronless/esd/test_esd_pairs.py
    - flake8 ./f5_openstack_agent
    - tox -e unit
    - python f5-openstack-agent-dist/scripts/universal_truth.py
    - echo "setup.cfg:"
    - cat setup.cfg
    - echo "stdeb.cfg:"
    - cat f5-openstack-agent-dist/deb_dist/stdeb.cfg
    - f5-openstack-agent-dist/scripts/package_agent.sh "redhat" "7"
    # - f5-openstack-agent-dist/scripts/package_agent.sh "redhat" "6"
    # pzhang: toomanyrequests: You have reached your pull rate limit. You may increase the limit by authenticating and upgrading: https://www.docker.com/increase-rate-limit
    - f5-openstack-agent-dist/scripts/package_agent.sh "ubuntu" "14.04"
    - sudo chown -R travis:travis ${DIST_REPO}/rpms/build
    # pzhang: toomanyrequests: You have reached your pull rate limit. You may increase the limit by authenticating and upgrading: https://www.docker.com/increase-rate-limit
    - sudo chown -R travis:travis ${DIST_REPO}/deb_dist/*.deb
    - f5-openstack-agent-dist/scripts/test_install.sh "redhat" "7" ${PKG_RELEASE_EL7}
    # pzhang: toomanyrequests: You have reached your pull rate limit. You may increase the limit by authenticating and upgrading: https://www.docker.com/increase-rate-limit
    - f5-openstack-agent-dist/scripts/test_install.sh "ubuntu" "14.04" ${PKG_RELEASE_1404}
    - |
      if [[ "$TRAVIS_BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]* ]]; then
        va=( ${TRAVIS_BRANCH//./ } ) # replace decimals and split into array
        export CTLR_VERSION="${va[0]}.${va[1]}.${va[2]}"
      else
        export CTLR_VERSION=$TRAVIS_BRANCH
      fi

after_success:
  - md5sum ${PKG_RELEASE_EL7} > ${PKG_RELEASE_EL7}.md5 && md5sum --check ${PKG_RELEASE_EL7}.md5
  - md5sum ${PKG_RELEASE_1404} > ${PKG_RELEASE_1404}.md5 && md5sum --check ${PKG_RELEASE_1404}.md5
deploy:
  - provider: releases
    api_key:
      secure: "iFpUAG1J8pnxL/lyIm4t18gQx0OaajpXWSEIQr0QeiKFKAj5mZ0rTr4XD4ditLKZ7Ar/ZcPlD+wJ6k4MEVjrkDs+SxSgMKoygXIu35m4pxNpUNPbyR1q0etfpnyMWr7KZWPhqzQw4FbQgAdNvA4l0CQi9ufaFIzE0gZl/uKW+CJbjRp+VrFKSeK1BuUSrjzS9iwwPy4DnxzOxmA8d3PLj/BCmh+rdjLHvdEAdVO5mRn6h2uTOTYsrYY+QBgI0Ibi1oiy6hkrW5snqEpaeg5w5fbcI9zds3QXWJucQSjBF8EFVgwcHHDM1Z339pnxbYHWZg683Q9tMjpUhgrc+CJxVW1O+vUaVkCa/6Js8B46RwgpZmBOWotxvYFfL/sxrvhh7mxnl/KSAHxMJ1NoReaS8SLBHqQu12/jyOQlblj+/jB/P/jAoj8R7S2p83FyNNuTg22zEV7oXIruaEsz4qfMNPR3RfVOTYzvKZPq6II67lHd5qNjAWNLpeDisBqHQ8dmE53Q10DtCLbzvzlLHbLtFExYToG1vwWNoe641vCa/ZEII2e0t0+tRIdXJ80Jgt2hHdTPpng0Xgsthf05SCwi2A9p0exVJt95ty7kEEUrpUZ9yEGFyO7H3kDvK7gk345BsMo7wIpoXgpp4uRwHy1Ylw3ZJPZG/J8Ju2D1eHtbF5Y="
    file:
      - ${PKG_RELEASE_EL7}
      - ${PKG_RELEASE_EL7}.md5
      - ${PKG_RELEASE_1404}
      - ${PKG_RELEASE_1404}.md5
    skip_cleanup: true
    overwrite: true
    on:
      repo: F5Networks/f5-openstack-agent
      tags: true
  #- provider: pypi
  #  user: $PYPI_USER
  #  password: $PYPI_PASSWORD
  #  distributions: "sdist bdist"
  #  server: https://upload.pypi.org/legacy/
  #  on:
  #    all_branches: true
  #    tags: true
  #    python: 2.7
  #  skip_cleanup: true
  - provider: script
    skip_cleanup: true
    on:
      all_branches: true
      repo: F5Networks/f5-openstack-agent
      tags: true
    script:
      - ./docs/scripts/docker-docs.sh ./docs/scripts/test-docs.sh && ./docs/scripts/deploy-docs.sh publish-product-docs-to-prod openstack/agent $CTLR_VERSION

notifications:
  slack:
    rooms:
      - f5openstackdev:$SLACK_TOKEN#f5-openstack-agent
      - f5openstackdev:$SLACK_TOKEN#build_status
    on_success: change
    on_failure: always
